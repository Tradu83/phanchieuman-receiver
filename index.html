<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Chiếu màn hình từ điện thoại</title>
  <style>
    body {
      margin: 0;
      background: black;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    canvas {
      max-width: 100%;
      max-height: 100%;
      background: #000;
    }
    #status {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      color: #0f0;
      font-family: monospace;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <canvas id="screen"></canvas>
  <div id="status">Đang kết nối...</div>

  <script>
    const canvas = document.getElementById("screen");
    const ctx = canvas.getContext("2d");
    const status = document.getElementById("status");

    // ⚠️ Ứng dụng Android sẽ gửi đúng ws://<IP>:<PORT>
    // Bạn chỉ cần để ChromeCast load file này, và service Android sẽ gửi URL bằng message
    // Ở đây cho debug local có thể set cứng:
    let wsUrl = null;

    // Hàm nhận message START_STREAM từ Android
    window.addEventListener("message", (event) => {
      try {
        const data = JSON.parse(event.data);
        if (data.type === "START_STREAM" && data.url) {
          wsUrl = data.url;
          startWebSocket();
        }
      } catch (e) {
        console.warn("Message parse error:", e);
      }
    });

    let ws;
    function startWebSocket() {
      if (!wsUrl) return;
      status.innerText = "Đang kết nối: " + wsUrl;

      ws = new WebSocket(wsUrl);
      ws.binaryType = "arraybuffer";

      ws.onopen = () => {
        status.innerText = "Đã kết nối: " + wsUrl;
      };

      ws.onmessage = (event) => {
        const bytes = new Uint8Array(event.data);
        const blob = new Blob([bytes], { type: "image/jpeg" });
        const img = new Image();
        img.onload = () => {
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
        };
        img.src = URL.createObjectURL(blob);
      };

      ws.onclose = () => {
        status.innerText = "Mất kết nối. Thử lại sau 2s...";
        setTimeout(startWebSocket, 2000);
      };

      ws.onerror = (e) => {
        console.error("WebSocket error:", e);
        ws.close();
      };
    }

    // DEBUG: Nếu bạn muốn test local PC (chưa nhận từ Android)
    // wsUrl = "ws://192.168.1.100:8088";
    // startWebSocket();
  </script>
</body>
</html>
