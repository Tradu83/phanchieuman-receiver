<!DOCTYPE html>
<html>
<head>
    <title>Screen Mirror Receiver</title>
    <meta charset="UTF-8">
    <style>
        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100%;
            overflow: hidden; background-color: #000;
        }
        img { 
            width: 100%; height: 100%; object-fit: contain; 
        }
    </style>
</head>
<body>
    <img id="screen-img" />
    
    <script src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
    <script>
        const context = cast.framework.CastReceiverContext.getInstance();
        const playerManager = context.getPlayerManager();
        const screenImg = document.getElementById('screen-img');
        let streamUrl = '';
        let refreshInterval = null;

        // Hàm để làm mới ảnh
        function refreshImage() {
            if (streamUrl) {
                // Thêm một tham số ngẫu nhiên để tránh trình duyệt cache ảnh cũ
                screenImg.src = streamUrl + '?t=' + new Date().getTime();
            }
        }

        // Tắt bộ đệm của trình phát mặc định
        playerManager.setMediaPlaybackInfoHandler((loadRequest, playbackConfig) => {
            return playbackConfig;
        });

        playerManager.setMessageInterceptor(
            cast.framework.messages.MessageType.LOAD,
            loadRequestData => {
                const media = loadRequestData.media;
                if (!media || !media.contentId) {
                    console.error('URL không hợp lệ!');
                    return null;
                }

                streamUrl = media.contentId;
                console.log('Bắt đầu nhận ảnh từ:', streamUrl);
                
                // Dừng interval cũ nếu có
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                }
                
                // Bắt đầu làm mới ảnh 15 lần mỗi giây
                refreshInterval = setInterval(refreshImage, 1000 / 15);
                
                return new cast.framework.messages.MediaInformation();
            }
        );
        
        context.addEventListener(cast.framework.system.EventType.SENDER_DISCONNECTED, () => {
            window.close();
        });

        const options = new cast.framework.CastReceiverOptions();
        options.disableIdleTimeout = true;
        context.start(options);
    </script>
</body>
</html>
